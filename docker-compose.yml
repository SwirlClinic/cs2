services:
  cs2:
    build: .
    container_name: cs2-server
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    env_file: .env
    ports:
      - "27015:27015/tcp"
      - "27015:27015/udp"
      - "27020:27020/udp"
    volumes:
      - cs2-data:/home/steam/cs2-dedicated
    deploy:
      resources:
        limits:
          memory: 8g

  mysql:
    image: mysql:8.0
    container_name: cs2-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${WP_DB_PASS:-weaponpaints}
      MYSQL_DATABASE: ${WP_DB_NAME:-weaponpaints}
      MYSQL_USER: ${WP_DB_USER:-weaponpaints}
      MYSQL_PASSWORD: ${WP_DB_PASS:-weaponpaints}
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  wp-php:
    build:
      context: ./web
      target: php
    container_name: cs2-wp-php
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    env_file: .env
    volumes:
      - wp-html:/var/www/html

  wp-nginx:
    build:
      context: ./web
      target: nginx
    container_name: cs2-wp-nginx
    restart: unless-stopped
    depends_on:
      - wp-php
    ports:
      - "${WP_WEB_PORT:-8080}:80"
    volumes:
      - wp-html:/var/www/html:ro

volumes:
  cs2-data:
  mysql-data:
  wp-html:
